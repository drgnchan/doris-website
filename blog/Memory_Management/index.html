<!doctype html>
<html lang="en-US" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
<meta name="generator" content="Docusaurus v2.4.1">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Apache Doris RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Apache Doris Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DT7W9E9722"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DT7W9E9722",{anonymize_ip:!0})</script>






<link rel="icon" href="/images/logo-only.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#FFFFFF">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/img/docusaurus.png">
<link rel="mask-icon" href="/img/docusaurus.svg" color="rgb(37, 194, 160)">
<meta name="msapplication-TileImage" content="/img/docusaurus.png">
<meta name="msapplication-TileColor" content="#000">


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:500">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:400"><title data-rh="true">Say Goodbye to OOM Crashes - Apache Doris</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://doris.apache.org/blog/Memory_Management"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Say Goodbye to OOM Crashes - Apache Doris"><meta data-rh="true" name="description" content="&lt;!--"><meta data-rh="true" property="og:description" content="&lt;!--"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2023-06-16T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="Tech Sharing"><link data-rh="true" rel="icon" href="/images/favicon.ico"><link data-rh="true" rel="canonical" href="https://doris.apache.org/blog/Memory_Management"><link data-rh="true" rel="alternate" href="https://doris.apache.org/blog/Memory_Management" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://doris.apache.org/zh-CN/blog/Memory_Management" hreflang="zh-Hans-CN"><link data-rh="true" rel="alternate" href="https://doris.apache.org/blog/Memory_Management" hreflang="x-default"><link rel="stylesheet" href="https://cdnd.selectdb.com/assets/css/styles.f8358eb8.css">
<link rel="preload" href="https://cdnd.selectdb.com/assets/js/runtime~main.1960a755.js" as="script">
<link rel="preload" href="https://cdnd.selectdb.com/assets/js/main.1a5254a5.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_s0pr" style="background-color:#3C2FD4;color:#FFFFFF" role="banner"><div class="announcementBarPlaceholder_qxfj"></div><div class="announcementBarContent_dpRF"><a href="https://github.com/apache/doris" target="_blank" style="display: flex; width: 100%; align-items: center; justify-content: center; margin-left: 4px; text-decoration: none; color: white">Do you like Apache Dorisï¼ŸGive us a ðŸŒŸ on GitHub 
                        <img style="width: 1.2rem; height: 1.2rem; margin-left: 0.4rem;" src="/images/github-white-icon.svg">
                    </a></div><button type="button" class="clean-btn close announcementBarClose_iXyO" aria-label="Close"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="https://cdnd.selectdb.com/images/logo.svg" alt="Apache Doris" class="themedImage_ToTc themedImage--light_HNdA"><img src="https://cdnd.selectdb.com/images/logo.svg" alt="Apache Doris" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" style="text-align:center" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/dev/get-starting/what-is-apache-doris">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" style="text-align:left" align="left" href="/learning">Learning Path</a></li><li><a class="dropdown__link" style="text-align:left" align="left" href="/docs/dev/get-starting/quick-start">Getting Started</a></li><li><a class="dropdown__link" style="text-align:left" align="left" href="/docs/dev/install/standard-deployment">Install and Deploy</a></li><li><a class="dropdown__link" style="text-align:left" align="left" href="/docs/dev/faq/install-faq">FAQ</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" style="text-align:center" href="/blog">Blogs</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/community/join-community">Community</a><ul class="dropdown__menu"><li><a class="dropdown__link" style="text-align:left" align="left" href="/community/join-community">Join Community</a></li><li><a class="dropdown__link" style="text-align:left" align="left" href="/community/team">Doris Team</a></li><li><a class="dropdown__link" style="text-align:left" align="left" href="/community/how-to-contribute/">How to Contribute</a></li><li><a class="dropdown__link" style="text-align:left" align="left" href="/community/developer-guide/debug-tool">Developer Guide</a></li></ul></div><a class="navbar__item navbar__link" style="text-align:center" href="/users">User Stories</a></div><div class="navbar__items navbar__items--right"><div class="versions">Version<!-- -->:<div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/dev/get-starting/quick-start">dev</a><ul class="dropdown__menu"><li><a class="dropdown__link" style="text-align:center" href="/docs/dev/get-starting/quick-start">dev</a></li><li><a class="dropdown__link" style="text-align:center" href="/docs/1.2/get-starting/">1.2</a></li></ul></div></div><a class="navbar__item navbar__link header-right-button-primary navbar-download-mobile" style="text-align:center" href="/download">Download</a><div class="navbar-search searchBox_ZlJk"><div class="navbar__search searchBarContainer_PzyC"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing__K5d searchBarLoadingRing_e2f0"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_m7ml"><kbd class="searchHint_zuPL">ctrl</kbd><kbd class="searchHint_zuPL">K</kbd></div></div></div><span class="github-btn desktop header-right-button-github"><span class="github-btn github-btn-large"><a class="gh-btn" href="//github.com/apache/doris/" target="_blank"><span class="gh-ico" aria-hidden="true"></span><span class="gh-text">Star</span></a><a class="gh-count" target="_blank" href="//github.com/apache/doris/stargazers/"></a></span></span><a class="header-right-button-primary navbar-download-desktop" href="/download">Download</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="main-wrapper"><div class="container margin-vert--lg blog-container"><div class="row"><main class="col col--9 col--offset-1" itemscope="" itemtype="http://schema.org/Blog"><article class="blog-article-content" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blog-post-title" itemprop="headline">Say Goodbye to OOM Crashes</h1><div class="blog-info"><time datetime="2023-06-16T00:00:00.000Z" itemprop="datePublished">June 16, 2023</time><span class="split-line"></span><span class="authors"><span class="s-author">Apache Doris</span></span><span class="split-line"></span><span class="s-tags"><span class="s-tag">Tech Sharing</span></span></div></header><div id="__blog-post-container" class="markdown" itemprop="articleBody"><p>What guarantees system stability in large data query tasks? It is an effective memory allocation and monitoring mechanism. It is how you speed up computation, avoid memory hotspots, promptly respond to insufficient memory, and minimize OOM errors. </p><p><img loading="lazy" src="https://cdnd.selectdb.com/assets/images/OOM_1-cbcc6d864b892831d6e8e3acf37a356f.png" width="1226" height="214" class="img_ev3q"></p><p>From a database user&#x27;s perspective, how do they suffer from bad memory management? This is a list of things that used to bother our users:</p><ul><li>OOM errors cause backend processes to crash. To quote one of our community members: Hi, Apache Doris, it&#x27;s okay to slow things down or fail a few tasks when you are short of memory, but throwing a downtime is just not cool.</li><li>Backend processes consume too much memory space, but there is no way to find the exact task to blame or limit the memory usage for a single query.</li><li>It is hard to set a proper memory size for each query, so chances are that a query gets canceled even when there is plenty of memory space.</li><li>High-concurrency queries are disproportionately slow, and memory hotspots are hard to locate.</li><li>Intermediate data during HashTable creation cannot be flushed to disks, so join queries between two large tables often fail due to OOM. </li></ul><p>Luckily, those dark days are behind us, because we have improved our memory management mechanism from the bottom up. Now get ready, things are going to be intensive.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="memory-allocation">Memory Allocation<a href="#memory-allocation" class="hash-link" aria-label="Direct link to Memory Allocation" title="Direct link to Memory Allocation">â€‹</a></h2><p>In Apache Doris, we have a one-and-only interface for memory allocation: <strong>Allocator</strong>. It will make adjustments as it sees appropriate to keep memory usage efficient and under control. Also, MemTrackers are in place to track the allocated or released memory size, and three different data structures are responsible for large memory allocation in operator execution (we will get to them immediately).   </p><p><img loading="lazy" src="https://cdnd.selectdb.com/assets/images/OOM_2-2804f7f38fc4bfec4b20bb6f1ce2416e.png" width="1228" height="568" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="data-structures-in-memory">Data Structures in Memory<a href="#data-structures-in-memory" class="hash-link" aria-label="Direct link to Data Structures in Memory" title="Direct link to Data Structures in Memory">â€‹</a></h3><p>As different queries have different memory hotspot patterns in execution, Apache Doris provides three different in-memory data structures: <strong>Arena</strong>, <strong>HashTable</strong>, and <strong>PODArray</strong>. They are all under the reign of the Allocator.</p><p><img loading="lazy" src="https://cdnd.selectdb.com/assets/images/OOM_3-9450598001ffa0bb838abad7bc62efb6.png" width="1222" height="758" class="img_ev3q"></p><p><strong>1. Arena</strong></p><p>The Arena is a memory pool that maintains a list of chunks, which are to be allocated upon request from the Allocator. The chunks support memory alignment. They exist throughout the lifespan of the Arena, and will be freed up upon destruction (usually when the query is completed). Chunks are mainly used to store the serialized or deserialized data during Shuffle, or the serialized Keys in HashTables.</p><p>The initial size of a chunk is 4096 bytes. If the current chunk is smaller than the requested memory, a new chunk will be added to the list. If the current chunk is smaller than 128M, the new chunk will double its size; if it is larger than 128M, the new chunk will, at most, be 128M larger than what is required. The old small chunk will not be allocated for new requests. There is a cursor to mark the dividing line of chunks allocated and those unallocated.</p><p><strong>2. HashTable</strong></p><p>HashTables are applicable for Hash Joins, aggregations, set operations, and window functions. The PartitionedHashTable structure supports no more than 16 sub-HashTables. It also supports the parallel merging of HashTables and each sub-Hash Join can be scaled independently. These can reduce overall memory usage and the latency caused by scaling.</p><p>If the current HashTable is smaller than 8M, it will be scaled by a factor of 4; </p><p>If it is larger than 8M, it will be scaled by a factor of 2; </p><p>If it is smaller than 2G, it will be scaled when it is 50% full;</p><p>And if it is larger than 2G, it will be scaled when it is 75% full. </p><p>The newly created HashTables will be pre-scaled based on how much data it is going to have. We also provide different types of HashTables for different scenarios. For example, for aggregations, you can apply PHmap.</p><p><strong>3. PODArray</strong></p><p>PODArray, as the name suggests, is a dynamic array of POD. The difference between it and <code>std::vector</code> is that PODArray does not initialize elements. It supports memory alignment and some interfaces of <code>std::vector</code>. It is scaled by a factor of 2. In destruction, instead of calling the destructor function for each element, it releases memory of the whole PODArray. PODArray is mainly used to save strings in columns and is applicable in many function computation and expression filtering.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="memory-interface">Memory Interface<a href="#memory-interface" class="hash-link" aria-label="Direct link to Memory Interface" title="Direct link to Memory Interface">â€‹</a></h3><p>As the only interface that coordinates Arena, PODArray, and HashTable, the Allocator executes memory mapping (MMAP) allocation for requests larger than 64M. Those smaller than 4K will be directly allocated from the system via malloc/free; and those in between will be accelerated by a general-purpose caching ChunkAllocator, which brings a 10% performance increase according to our benchmarking results. The ChunkAllocator will try and retrieve a chunk of the specified size from the FreeList of the current core in a lock-free manner; if such a chunk doesn&#x27;t exist, it will try from other cores in a lock-based manner; if that still fails, it will request the specified memory size from the system and encapsulate it into a chunk.</p><p>We chose Jemalloc over TCMalloc after experience with both of them. We tried TCMalloc in our high-concurrency tests and noticed that Spin Lock in CentralFreeList took up 40% of the total query time. Disabling &quot;aggressive memory decommit&quot; made things better, but that brought much more memory usage, so we had to use an individual thread to regularly recycle cache. Jemalloc, on the other hand, was more performant and stable in high-concurrency queries. After fine-tuning for other scenarios, it delivered the same performance as TCMalloc but consumed less memory.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="memory-reuse">Memory Reuse<a href="#memory-reuse" class="hash-link" aria-label="Direct link to Memory Reuse" title="Direct link to Memory Reuse">â€‹</a></h3><p>Memory reuse is widely executed on the execution layer of Apache Doris. For example, data blocks will be reused throughout the execution of a query. During Shuffle, there will be two blocks at the Sender end and they work alternately, one receiving data and the other in RPC transport. When reading a tablet, Doris will reuse the predicate column, implement cyclic reading, filter, copy filtered data to the upper block, and then clear. When ingesting data into an Aggregate Key table, once the MemTable that caches data reaches a certain size, it will be pre-aggregated and then more data will be written in. </p><p>Memory reuse is executed in data scanning, too. Before the scanning starts, a number of free blocks (depending on the number of scanners and threads) will be allocated to the scanning task. During each scanner scheduling, one of the free blocks will be passed to the storage layer for data reading. After data reading, the block will be put into the producer queue for consumption of the upper operators in subsequent computation. Once an upper operator has copied the computation data from the block, the block will go back in the free blocks for next scanner scheduling. The thread the preallocates the free blocks will also be responsible for freeing them up after data scanning, so there won&#x27;t be extra overheads. The number of free blocks somehow determines the concurrency of data scanning.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="memory-tracking">Memory Tracking<a href="#memory-tracking" class="hash-link" aria-label="Direct link to Memory Tracking" title="Direct link to Memory Tracking">â€‹</a></h2><p> Apache Doris uses MemTrackers to follow up on the allocation and releasing of memory while analyzing memory hotspots. The MemTrackers keep records of each data query, data ingestion, data compaction task, and the memory size of each global object, such as Cache and TabletMeta. It supports both manual counting and MemHook auto-tracking. Users can view the real-time memory usage in Doris backend on a Web page. </p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="structure-of-memtrackers">Structure of MemTrackers<a href="#structure-of-memtrackers" class="hash-link" aria-label="Direct link to Structure of MemTrackers" title="Direct link to Structure of MemTrackers">â€‹</a></h3><p>The MemTracker system before Apache Doris 1.2.0 was in a hierarchical tree structure, consisting of process_mem_tracker, query_pool_mem_tracker, query_mem_tracker, instance_mem_tracker, ExecNode_mem_tracker and so on. MemTrackers of two neighbouring layers are of parent-child relationship. Hence, any calculation mistakes in a child MemTracker will be accumulated all the way up and result in a larger scale of incredibility. </p><p><img loading="lazy" src="https://cdnd.selectdb.com/assets/images/OOM_4-90b44adf02bc4653708948cf5e65d50e.png" width="1280" height="419" class="img_ev3q"></p><p>In Apache Doris 1.2.0 and newer, we made the structure of MemTrackers much simpler. MemTrackers are only divided into two types based on their roles: <strong>MemTracker Limiter</strong> and the others. MemTracker Limiter, monitoring memory usage, is unique in every query/ingestion/compaction task and global object; while the other MemTrackers traces the memory hotspots in query execution, such as HashTables in Join/Aggregation/Sort/Window functions and intermediate data in serialization, to give a picture of how memory is used in different operators or provide reference for memory control in data flushing.</p><p>The parent-child relationship between MemTracker Limiter and other MemTrackers is only manifested in snapshot printing. You can think of such a relationship as a symbolic link. They are not consumed at the same time, and the lifecycle of one does not affect that of the other. This makes it much easier for developers to understand and use them. </p><p>MemTrackers (including MemTracker Limiter and the others) are put into a group of Maps. They allow users to print overall MemTracker type snapshot, Query/Load/Compaction task snapshot, and find out the Query/Load with the most memory usage or the most memory overusage. </p><p><img loading="lazy" src="https://cdnd.selectdb.com/assets/images/OOM_5-beba9f4c16d66d0df644f9e69a3b7db3.png" width="1280" height="1063" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-memtracker-works">How MemTracker Works<a href="#how-memtracker-works" class="hash-link" aria-label="Direct link to How MemTracker Works" title="Direct link to How MemTracker Works">â€‹</a></h3><p>To calculate memory usage of a certain execution, a MemTracker is added to a stack in Thread Local of the current thread. By reloading the malloc/free/realloc in Jemalloc or TCMalloc, MemHook obtains the actual size of the memory allocated or released, and records it in Thread Local of the current thread. When an execution is done, the relevant MemTracker will be removed from the stack. At the bottom of the stack is the MemTracker that records memory usage during the whole query/load execution process.</p><p>Now let me explain with a simplified query execution process.</p><ul><li>After a Doris backend node starts, the memory usage of all threads will be recorded in the Process MemTracker.</li><li>When a query is submitted, a <strong>Query MemTracker</strong> will be added to the Thread Local Storage(TLS) Stack in the fragment execution thread.</li><li>Once a ScanNode is scheduled, a <strong>ScanNode MemTracker</strong> will be added to Thread Local Storage(TLS) Stack in the fragment execution thread. Then, any memory allocated or released in this thread will be recorded into both the Query MemTracker and the ScanNode MemTracker.</li><li>After a Scanner is scheduled, a Query MemTracker and a <strong>Scanner MemTracker</strong> will be added to the TLS Stack of the Scanner thread.</li><li>When the scanning is done, all MemTrackers in the Scanner Thread TLS Stack will be removed. When the ScanNode scheduling is done, the ScanNode MemTracker will be removed from the fragment execution thread. Then, similarly, when an aggregation node is scheduled, an <strong>AggregationNode MemTracker</strong> will be added to the fragment execution thread TLS Stack, and get removed after the scheduling is done.</li><li>If the query is completed, the Query MemTracker will be removed from the fragment execution thread TLS Stack. At this point, this stack should be empty. Then, from the QueryProfile, you can view the peak memory usage during the whole query execution as well as each phase (scanning, aggregation, etc.).</li></ul><p><img loading="lazy" src="https://cdnd.selectdb.com/assets/images/OOM_6-cf0ef627ae1b9d5448b54ab92f9c3180.png" width="1280" height="424" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-use-memtracker">How to Use MemTracker<a href="#how-to-use-memtracker" class="hash-link" aria-label="Direct link to How to Use MemTracker" title="Direct link to How to Use MemTracker">â€‹</a></h3><p>The Doris backend Web page demonstrates real-time memory usage, which is divided into types: Query/Load/Compaction/Global. Current memory consumption and peak consumption are shown. </p><p><img loading="lazy" src="https://cdnd.selectdb.com/assets/images/OOM_7-4fef601c6c9f9a5fcc53b785485057d3.png" width="1280" height="562" class="img_ev3q"></p><p>The Global types include MemTrackers of Cache and TabletMeta.</p><p><img loading="lazy" src="https://cdnd.selectdb.com/assets/images/OOM_8-a007e2d4fa06263628f5d603471a3f79.png" width="1280" height="489" class="img_ev3q"></p><p>From the Query types, you can see the current memory consumption and peak consumption of the current query and the operators it involves (you can tell how they are related from the labels). For memory statistics of historical queries, you can check the Doris FE audit logs or BE INFO logs.</p><p><img loading="lazy" src="https://cdnd.selectdb.com/assets/images/OOM_9-32f7ad3c6b10088f0735cfd1ff0e1e39.png" width="1280" height="762" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="memory-limit">Memory Limit<a href="#memory-limit" class="hash-link" aria-label="Direct link to Memory Limit" title="Direct link to Memory Limit">â€‹</a></h2><p>With widely implemented memory tracking in Doris backends, we are one step closer to eliminating OOM, the cause of backend downtime and large-scale query failures. The next step is to optimize the memory limit on queries and processes to keep memory usage under control.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="memory-limit-on-query">Memory Limit on Query<a href="#memory-limit-on-query" class="hash-link" aria-label="Direct link to Memory Limit on Query" title="Direct link to Memory Limit on Query">â€‹</a></h3><p>Users can put a memory limit on every query. If that limit is exceeded during execution, the query will be canceled. But since version 1.2, we have allowed Memory Overcommit, which is a more flexible memory limit control. If there are sufficient memory resources, a query can consume more memory than the limit without being canceled, so users don&#x27;t have to pay extra attention to memory usage; if there are not, the query will wait until new memory space is allocated; only when the newly freed up memory is not enough for the query will the query be canceled.</p><p>While in Apache Doris 2.0, we have realized exception safety for queries. That means any insufficient memory allocation will immediately cause the query to be canceled, which saves the trouble of checking &quot;Cancel&quot; status in subsequent steps.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="memory-limit-on-process">Memory Limit on Process<a href="#memory-limit-on-process" class="hash-link" aria-label="Direct link to Memory Limit on Process" title="Direct link to Memory Limit on Process">â€‹</a></h3><p>On a regular basis, Doris backend retrieves the physical memory of processes and the currently available memory size from the system. Meanwhile, it collects MemTracker snapshots of all Query/Load/Compaction tasks. If a backend process exceeds its memory limit or there is insufficient memory, Doris will free up some memory space by clearing Cache and cancelling a number of queries or data ingestion tasks. These will be executed by an individual GC thread regularly.</p><p><img loading="lazy" src="https://cdnd.selectdb.com/assets/images/OOM_10-4926bcb7439768952d6d973697de2468.png" width="1280" height="610" class="img_ev3q"></p><p>If the process memory consumed is over the SoftMemLimit (81% of total system memory, by default), or the available system memory drops below the Warning Water Mark (less than 3.2GB), <strong>Minor GC</strong> will be triggered. At this moment, query execution will be paused at the memory allocation step, the cached data in data ingestion tasks will be force flushed, and part of the Data Page Cache and the outdated Segment Cache will be released. If the newly released memory does not cover 10% of the process memory, with Memory Overcommit enabled, Doris will start cancelling the queries which are the biggest &quot;overcommitters&quot; until the 10% target is met or all queries are canceled. Then, Doris will shorten the system memory checking interval and the GC interval. The queries will be continued after more memory is available.</p><p>If the process memory consumed is beyond the MemLimit (90% of total system memory, by default), or the available system memory drops below the Low Water Mark (less than 1.6GB), <strong>Full GC</strong> will be triggered. At this time, data ingestion tasks will be stopped, and all Data Page Cache and most other Cache will be released. If, after all these steps, the newly released memory does not cover 20% of the process memory, Doris will look into all MemTrackers and find the most memory-consuming queries and ingestion tasks, and cancel them one by one. Only after the 20% target is met will the system memory checking interval and the GC interval be extended, and the queries and ingestion tasks be continued. (One garbage collection operation usually takes hundreds of Î¼s to dozens of ms.)</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="influences-and-outcomes">Influences and Outcomes<a href="#influences-and-outcomes" class="hash-link" aria-label="Direct link to Influences and Outcomes" title="Direct link to Influences and Outcomes">â€‹</a></h2><p>After optimizations in memory allocation, memory tracking, and memory limit, we have substantially increased the stability and high-concurrency performance of Apache Doris as a real-time analytic data warehouse platform. OOM crash in the backend is a rare scene now. Even if there is an OOM, users can locate the problem root based on the logs and then fix it. In addition, with more flexible memory limits on queries and data ingestion, users don&#x27;t have to spend extra effort taking care of memory when memory space is adequate. </p><p>In the next phase, we plan to ensure completion of queries in memory overcommitment, which means less queries will have to be canceled due to memory shortage. We have broken this objective into specific directions of work: exception safety, memory isolation between resource groups, and the flushing mechanism of intermediate data. If you want to meet our developers, <a href="https://t.co/XD4uUSROft" target="_blank" rel="noopener noreferrer">this is where you find us</a>.</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/HCDS"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Hot-Cold Data Separation: What, Why, and How?</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/Compaction"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Understanding Data Compaction in 3 Minutes</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#memory-allocation" class="table-of-contents__link toc-highlight">Memory Allocation</a><ul><li><a href="#data-structures-in-memory" class="table-of-contents__link toc-highlight">Data Structures in Memory</a></li><li><a href="#memory-interface" class="table-of-contents__link toc-highlight">Memory Interface</a></li><li><a href="#memory-reuse" class="table-of-contents__link toc-highlight">Memory Reuse</a></li></ul></li><li><a href="#memory-tracking" class="table-of-contents__link toc-highlight">Memory Tracking</a><ul><li><a href="#structure-of-memtrackers" class="table-of-contents__link toc-highlight">Structure of MemTrackers</a></li><li><a href="#how-memtracker-works" class="table-of-contents__link toc-highlight">How MemTracker Works</a></li><li><a href="#how-to-use-memtracker" class="table-of-contents__link toc-highlight">How to Use MemTracker</a></li></ul></li><li><a href="#memory-limit" class="table-of-contents__link toc-highlight">Memory Limit</a><ul><li><a href="#memory-limit-on-query" class="table-of-contents__link toc-highlight">Memory Limit on Query</a></li><li><a href="#memory-limit-on-process" class="table-of-contents__link toc-highlight">Memory Limit on Process</a></li></ul></li><li><a href="#influences-and-outcomes" class="table-of-contents__link toc-highlight">Influences and Outcomes</a></li></ul></div></div></div></div></div></div><div class="footer"><div class="container"><div class="footer-box"><div class="left"><img src="/images/asf_logo_apache.svg" alt="" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/images/asf_logo_apache.svg" alt="" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ASF</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Foundation<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="footer__link-item">License<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="footer__link-item">Events<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sponsorship<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Thanks<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/download">Download</a></li><li class="footer__item"><a class="footer__link-item" href="/learning">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blogs</a></li><li class="footer__item"><a class="footer__link-item" href="/users">User Stories</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community Support</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/community/team">Doris Team</a></li><li class="footer__item"><a class="footer__link-item" href="/community/how-to-contribute/">How to Contribute</a></li><li class="footer__item"><a href="https://github.com/apache/doris/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Source Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/doris/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">Improvement Proposal<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/doris/issues/16392" target="_blank" rel="noopener noreferrer" class="footer__link-item">Roadmap<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div><div class="right"><div class="footer__title">Connect with Us</div><div class="social-list"><div class="social"><a href="mailto:dev@doris.apache.org" target="_blank" title="mail" class="item"><svg width="2em" height="2em" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5.6003 6H26.3997C27.8186 6 28.982 7.10964 29 8.46946L16.0045 15.454L3.01202 8.47829C3.02405 7.11258 4.1784 6 5.6003 6ZM3.01202 11.1508L3 23.5011C3 24.8756 4.16938 26 5.6003 26H26.3997C27.8306 26 29 24.8756 29 23.5011V11.145L16.3111 17.8028C16.1157 17.9058 15.8813 17.9058 15.6889 17.8028L3.01202 11.1508V11.1508Z" fill="currentColor"></path></svg></a><a href="https://github.com/apache/doris" target="_blank" title="github" class="item"><svg width="2em" height="2em" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16.0001 2.66675C8.63342 2.66675 2.66675 8.63341 2.66675 16.0001C2.66524 18.7991 3.54517 21.5276 5.1817 23.7983C6.81824 26.0691 9.12828 27.7668 11.7841 28.6508C12.4508 28.7668 12.7001 28.3668 12.7001 28.0161C12.7001 27.7001 12.6828 26.6508 12.6828 25.5334C9.33342 26.1508 8.46675 24.7174 8.20008 23.9668C8.04942 23.5828 7.40008 22.4001 6.83342 22.0828C6.36675 21.8334 5.70008 21.2161 6.81608 21.2001C7.86675 21.1828 8.61608 22.1668 8.86675 22.5668C10.0668 24.5828 11.9841 24.0161 12.7494 23.6668C12.8668 22.8001 13.2161 22.2174 13.6001 21.8841C10.6334 21.5508 7.53342 20.4001 7.53342 15.3001C7.53342 13.8494 8.04942 12.6507 8.90008 11.7161C8.76675 11.3827 8.30008 10.0161 9.03342 8.18275C9.03342 8.18275 10.1494 7.83342 12.7001 9.55075C13.7855 9.2495 14.907 9.09787 16.0334 9.10008C17.1668 9.10008 18.3001 9.24942 19.3668 9.54942C21.9161 7.81608 23.0334 8.18408 23.0334 8.18408C23.7668 10.0174 23.3001 11.3841 23.1668 11.7174C24.0161 12.6507 24.5334 13.8334 24.5334 15.3001C24.5334 20.4174 21.4174 21.5508 18.4508 21.8841C18.9334 22.3001 19.3508 23.1001 19.3508 24.3508C19.3508 26.1334 19.3334 27.5668 19.3334 28.0174C19.3334 28.3668 19.5841 28.7828 20.2508 28.6494C22.8975 27.7558 25.1973 26.0547 26.8266 23.7856C28.4559 21.5165 29.3327 18.7936 29.3334 16.0001C29.3334 8.63341 23.3668 2.66675 16.0001 2.66675V2.66675Z" fill="currentColor"></path></svg></a><a href="https://twitter.com/doris_apache" target="_blank" title="twitter" class="item"><svg width="2rem" height="2rem" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 3H10.6067L29 29H21.3933L3 3ZM6.31485 4.69302L22.3127 27.307H25.6852L9.68727 4.69302H6.31485Z" fill="white"></path><path d="M14.202 18.8346L5.18225 29H3L13.2092 17.4314L14.202 18.8346ZM18.4342 14.0647L28.2518 3H25.9448L17.4314 12.6471L18.4342 14.0647Z" fill="white"></path></svg></a></div><div class="social"><a href="https://join.slack.com/t/apachedoriscommunity/shared_invite/zt-1x7x8fger-F7NoshFQn~djlvGdnEtxUQ" title="slack" target="_blank" class="item"><svg width="2em" height="2em" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_125_278)"><path d="M12.5875 16.6906C11.0844 16.6906 9.86562 17.9094 9.86562 19.4125V26.2375C9.86562 26.9594 10.1524 27.6517 10.6628 28.1622C11.1733 28.6726 11.8656 28.9594 12.5875 28.9594C13.3094 28.9594 14.0017 28.6726 14.5122 28.1622C15.0226 27.6517 15.3094 26.9594 15.3094 26.2375V19.4531C15.3094 17.9094 14.0906 16.6906 12.5875 16.6906ZM3 19.4531C3 20.175 3.28677 20.8673 3.79722 21.3778C4.30767 21.8882 4.99999 22.175 5.72187 22.175C6.44376 22.175 7.13608 21.8882 7.64653 21.3778C8.15698 20.8673 8.44375 20.175 8.44375 19.4531V16.7312H5.7625C4.25938 16.6906 3 17.9094 3 19.4531ZM12.5875 3C11.8656 3 11.1733 3.28677 10.6628 3.79722C10.1524 4.30767 9.86562 4.99999 9.86562 5.72187C9.86562 6.44376 10.1524 7.13608 10.6628 7.64653C11.1733 8.15698 11.8656 8.44375 12.5875 8.44375H15.3094V5.72187C15.3094 4.21875 14.0906 3 12.5875 3ZM5.72187 15.3094H12.5469C13.2688 15.3094 13.9611 15.0226 14.4715 14.5122C14.982 14.0017 15.2688 13.3094 15.2688 12.5875C15.2688 11.8656 14.982 11.1733 14.4715 10.6628C13.9611 10.1524 13.2688 9.86562 12.5469 9.86562H5.72187C4.99999 9.86562 4.30767 10.1524 3.79722 10.6628C3.28677 11.1733 3 11.8656 3 12.5875C3 13.3094 3.28677 14.0017 3.79722 14.5122C4.30767 15.0226 4.99999 15.3094 5.72187 15.3094ZM26.2375 9.86562C24.7344 9.86562 23.5156 11.0844 23.5156 12.5875V15.3094H26.2375C26.9594 15.3094 27.6517 15.0226 28.1622 14.5122C28.6726 14.0017 28.9594 13.3094 28.9594 12.5875C28.9594 11.8656 28.6726 11.1733 28.1622 10.6628C27.6517 10.1524 26.9594 9.86562 26.2375 9.86562ZM16.6906 5.72187V12.5875C16.6906 13.3094 16.9774 14.0017 17.4878 14.5122C17.9983 15.0226 18.6906 15.3094 19.4125 15.3094C20.1344 15.3094 20.8267 15.0226 21.3372 14.5122C21.8476 14.0017 22.1344 13.3094 22.1344 12.5875V5.72187C22.1344 4.99999 21.8476 4.30767 21.3372 3.79722C20.8267 3.28677 20.1344 3 19.4125 3C18.6906 3 17.9983 3.28677 17.4878 3.79722C16.9774 4.30767 16.6906 4.99999 16.6906 5.72187ZM22.1344 26.2781C22.1344 24.775 20.9156 23.5562 19.4125 23.5562H16.6906V26.2781C16.6906 27 16.9774 27.6923 17.4878 28.2028C17.9983 28.7132 18.6906 29 19.4125 29C20.1344 29 20.8267 28.7132 21.3372 28.2028C21.8476 27.6923 22.1344 27 22.1344 26.2781ZM26.2781 16.6906H19.4125C18.6906 16.6906 17.9983 16.9774 17.4878 17.4878C16.9774 17.9983 16.6906 18.6906 16.6906 19.4125C16.6906 20.1344 16.9774 20.8267 17.4878 21.3372C17.9983 21.8476 18.6906 22.1344 19.4125 22.1344H26.2375C27.7406 22.1344 28.9594 20.9156 28.9594 19.4125C29 17.9094 27.7812 16.6906 26.2781 16.6906Z" fill="currentColor"></path></g><defs><clipPath id="clip0_125_278"><rect width="26" height="26" fill="currentColor" transform="translate(3 3)"></rect></clipPath></defs></svg></a><a href="https://www.youtube.com/@apachedoris/channels" title="youtube" target="_blank" class="item"><svg width="2rem" height="2rem" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_3462_1106)"><path d="M30.3048 7.66776C30.7927 8.14769 31.1465 8.74331 31.3319 9.39705C31.7949 11.91 32.0182 14.46 31.9988 17.0138C32.0164 19.558 31.7931 22.0982 31.3319 24.6017C31.1465 25.2554 30.7927 25.851 30.3048 26.3309C29.8169 26.8109 29.2115 27.1589 28.5469 27.3413C26.026 28 16.0142 28 16.0142 28C16.0142 28 5.97317 28 3.48158 27.3413C2.81702 27.1589 2.21154 26.8109 1.72366 26.3309C1.23579 25.851 0.882017 25.2554 0.696547 24.6017C0.22555 22.0991 -0.00754264 19.5589 0.000288097 17.0138C-0.00936809 14.4591 0.223732 11.9091 0.696547 9.39705C0.882017 8.74331 1.23579 8.14769 1.72366 7.66776C2.21154 7.18784 2.81702 6.83983 3.48158 6.65738C6.00118 5.9869 16.0142 6.00002 16.0142 6.00002C16.0142 6.00002 26.0526 6.00002 28.5469 6.65738C29.2115 6.83983 29.8169 7.18784 30.3048 7.66776ZM12 23L22 17.0092L12 11V23Z" fill="white"></path></g><defs><clipPath id="clip0_3462_1106"><rect width="32" height="32" fill="white"></rect></clipPath></defs></svg></a><a href="https://www.linkedin.com/company/doris-apache/" title="linkedin" target="_blank" class="item"><svg width="2rem" height="2rem" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4.29925 26.9996H9.66738V11.6781H4.29925V26.9996ZM22.1628 11.1949C19.9409 11.1949 18.7157 11.9388 17.3054 13.7407V11.6777H11.9459V26.9996H17.305V18.6738C17.305 16.9168 18.145 15.1982 20.1535 15.1982C22.162 15.1982 22.6559 16.9164 22.6559 18.632V27H28V18.2902C28 12.2386 24.3854 11.1949 22.1628 11.1949ZM6.99325 4C5.3395 4 4 5.21047 4 6.7046C4 8.19759 5.3395 9.40617 6.99325 9.40617C8.6455 9.40617 9.985 8.19722 9.985 6.7046C9.985 5.21047 8.6455 4 6.99325 4Z" fill="white"></path></svg></a></div></div></div></div><div class="footer__copyright">Copyright Â© 2023 The Apache Software Foundation,Licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache License, Version 2.0</a>. Apache, Doris, Apache Doris, the Apache feather logo and the Apache Doris logo are trademarks of The Apache Software Foundation.</div></div></div></div>
<script src="https://cdnd.selectdb.com/assets/js/runtime~main.1960a755.js"></script>
<script src="https://cdnd.selectdb.com/assets/js/main.1a5254a5.js"></script>
</body>
</html>