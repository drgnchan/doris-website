<!doctype html>
<html lang="zh-Hans-CN" dir="ltr" class="docs-wrapper docs-doc-page docs-version-2.0 plugin-docs plugin-id-default docs-doc-id-data-operate/import/import-way/binlog-load-manual" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
<meta name="generator" content="Docusaurus v2.4.3">
<link rel="alternate" type="application/rss+xml" href="/zh-CN/blog/rss.xml" title="Apache Doris RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-CN/blog/atom.xml" title="Apache Doris Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DT7W9E9722"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-DT7W9E9722",{anonymize_ip:!0})</script>






<link rel="icon" href="/zh-CN/images/logo-only.png">
<link rel="manifest" href="/zh-CN/manifest.json">
<meta name="theme-color" content="#FFFFFF">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/zh-CN/img/docusaurus.png">
<link rel="mask-icon" href="/zh-CN/img/docusaurus.svg" color="rgb(37, 194, 160)">
<meta name="msapplication-TileImage" content="/zh-CN/img/docusaurus.png">
<meta name="msapplication-TileColor" content="#000">


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:500">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:400"><title data-rh="true">Binlog Load - Apache Doris</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://doris.apache.org/zh-CN/docs/data-operate/import/import-way/binlog-load-manual"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="docusaurus_version" content="2.0"><meta data-rh="true" name="docusaurus_tag" content="docs-default-2.0"><meta data-rh="true" name="docsearch:version" content="2.0"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-2.0"><meta data-rh="true" property="og:title" content="Binlog Load - Apache Doris"><meta data-rh="true" name="description" content="&lt;!--"><meta data-rh="true" property="og:description" content="&lt;!--"><link data-rh="true" rel="icon" href="/zh-CN/images/favicon.ico"><link data-rh="true" rel="canonical" href="https://doris.apache.org/zh-CN/docs/data-operate/import/import-way/binlog-load-manual"><link data-rh="true" rel="alternate" href="https://doris.apache.org/docs/data-operate/import/import-way/binlog-load-manual" hreflang="en-US"><link data-rh="true" rel="alternate" href="https://doris.apache.org/zh-CN/docs/data-operate/import/import-way/binlog-load-manual" hreflang="zh-Hans-CN"><link data-rh="true" rel="alternate" href="https://doris.apache.org/docs/data-operate/import/import-way/binlog-load-manual" hreflang="x-default"><link rel="stylesheet" href="https://cdnd.selectdb.com/zh-CN/assets/css/styles.eb341a22.css">
<link rel="preload" href="https://cdnd.selectdb.com/zh-CN/assets/js/runtime~main.6055e683.js" as="script">
<link rel="preload" href="https://cdnd.selectdb.com/zh-CN/assets/js/main.afdadd9e.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><div class="announcementBar_s0pr" style="background-color:#3C2FD4;color:#FFFFFF" role="banner"><div class="announcementBarPlaceholder_qxfj"></div><div class="announcementBarContent_dpRF"><a href="https://github.com/apache/doris" target="_blank" style="display: flex; width: 100%; align-items: center; justify-content: center; margin-left: 4px; text-decoration: none; color: white">Do you like Apache Doris？Give us a 🌟 on GitHub 
                        <img style="width: 1.2rem; height: 1.2rem; margin-left: 0.4rem;" src="/images/github-white-icon.svg">
                    </a></div><button type="button" class="clean-btn close announcementBarClose_iXyO" aria-label="关闭"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-CN/"><div class="navbar__logo"><img src="https://cdnd.selectdb.com/images/logo.svg" alt="Apache Doris" class="themedImage_ToTc themedImage--light_HNdA"><img src="https://cdnd.selectdb.com/images/logo.svg" alt="Apache Doris" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a class="navbar__item navbar__link" style="text-align:center" href="/zh-CN/">Home</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/zh-CN/docs/get-starting/quick-start">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" style="text-align:left" align="left" href="/zh-CN/docs/get-starting/quick-start">Getting Started</a></li><li><a class="dropdown__link" style="text-align:left" align="left" href="/zh-CN/docs/install/standard-deployment">Install and Deploy</a></li><li><a class="dropdown__link" style="text-align:left" align="left" href="/zh-CN/docs/faq/install-faq">FAQ</a></li></ul></div><a class="navbar__item navbar__link" style="text-align:center" href="/zh-CN/blog">Blogs</a><div class="navbar__item dropdown dropdown--hoverable"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/zh-CN/community/join-community">Community</a><ul class="dropdown__menu"><li><a class="dropdown__link" style="text-align:left" align="left" href="/zh-CN/community/join-community">Join Community</a></li><li><a class="dropdown__link" style="text-align:left" align="left" href="/zh-CN/community/team">Doris Team</a></li><li><a class="dropdown__link" style="text-align:left" align="left" href="/zh-CN/community/how-to-contribute/">How to Contribute</a></li><li><a class="dropdown__link" style="text-align:left" align="left" href="/zh-CN/community/developer-guide/debug-tool">Developer Guide</a></li></ul></div><a class="navbar__item navbar__link" style="text-align:center" href="/zh-CN/users">User Stories</a></div><div class="navbar__items navbar__items--right"><div class="versions">Version<!-- -->:<div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/zh-CN/docs/get-starting/quick-start">2.0</a><ul class="dropdown__menu"><li><a class="dropdown__link" style="text-align:center" href="/zh-CN/docs/dev/data-operate/import/import-way/binlog-load-manual">dev</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" style="text-align:center" href="/zh-CN/docs/data-operate/import/import-way/binlog-load-manual">2.0</a></li><li><a class="dropdown__link" style="text-align:center" href="/zh-CN/docs/1.2/data-operate/import/import-way/binlog-load-manual">1.2</a></li></ul></div></div><div class="locale-box"><a href="/docs/data-operate/import/import-way/binlog-load-manual" target="_self" rel="noopener noreferrer" class="navbar__item navbar__link" style="text-align:center">EN</a><a href="/zh-CN/docs/data-operate/import/import-way/binlog-load-manual" target="_self" rel="noopener noreferrer" class="navbar__item navbar__link dropdown__link--active" style="text-align:center">中文</a></div><a class="navbar__item navbar__link header-right-button-primary navbar-download-mobile" style="text-align:center" href="/zh-CN/download">Download</a><div class="navbar-search searchBox_ZlJk"><div class="navbar__search searchBarContainer_PzyC"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing__K5d searchBarLoadingRing_e2f0"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_m7ml"><kbd class="searchHint_zuPL">ctrl</kbd><kbd class="searchHint_zuPL">K</kbd></div></div></div><a href="https://github.com/apache/doris" target="_blank" rel="noopener noreferrer" class="github-btn desktop header-right-button-github"></a><a class="header-right-button-primary navbar-download-desktop" href="/zh-CN/download">Download</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><div class="main-wrapper docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><main class="docMainContainer_gTbr docMainContainerEnhanced_Uz_u"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>Binlog Load</h1></header><h1>Binlog Load</h1><p>Binlog Load提供了一种使Doris增量同步用户在Mysql数据库的对数据更新操作的CDC(Change Data Capture)功能。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="适用场景">适用场景<a href="#适用场景" class="hash-link" aria-label="适用场景的直接链接" title="适用场景的直接链接">​</a></h2><ul><li>INSERT/UPDATE/DELETE支持</li><li>过滤Query</li><li>暂不兼容DDL语句</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="基本原理">基本原理<a href="#基本原理" class="hash-link" aria-label="基本原理的直接链接" title="基本原理的直接链接">​</a></h2><p>当前版本设计中，Binlog Load需要依赖canal作为中间媒介，让canal伪造成一个从节点去获取Mysql主节点上的Binlog并解析，再由Doris去获取Canal上解析好的数据，主要涉及Mysql端、Canal端以及Doris端，总体数据流向如下：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">+---------------------------------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|                    Mysql                    |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------------+----------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                       | Binlog</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------------v----------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|                 Canal Server                |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+-------------------+-----^-------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">               Get  |     |  Ack</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+-------------------|-----|-------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| FE                |     |                   |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| +-----------------|-----|----------------+  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| | Sync Job        |     |                |  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| |    +------------v-----+-----------+    |  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| |    | Canal Client                 |    |  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| |    |   +-----------------------+  |    |  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| |    |   |       Receiver        |  |    |  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| |    |   +-----------------------+  |    |  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| |    |   +-----------------------+  |    |  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| |    |   |       Consumer        |  |    |  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| |    |   +-----------------------+  |    |  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| |    +------------------------------+    |  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| +----+---------------+--------------+----+  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|      |               |              |       |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| +----v-----+   +-----v----+   +-----v----+  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| | Channel1 |   | Channel2 |   | Channel3 |  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| | [Table1] |   | [Table2] |   | [Table3] |  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| +----+-----+   +-----+----+   +-----+----+  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|      |               |              |       |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|   +--|-------+   +---|------+   +---|------+|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|  +---v------+|  +----v-----+|  +----v-----+||</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| +----------+|+ +----------+|+ +----------+|+|</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| |   Task   |+  |   Task   |+  |   Task   |+ |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| +----------+   +----------+   +----------+  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----------------------+----------------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     |                 |                  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----v-----------------v------------------v---+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|                 Coordinator                 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|                     BE                      |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----+-----------------+------------------+---+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     |                 |                  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+----v---+         +---v----+        +----v---+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|   BE   |         |   BE   |        |   BE   |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+--------+         +--------+        +--------+</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如上图，用户向FE提交一个数据同步作业。</p><p>FE会为每个数据同步作业启动一个canal client，来向canal server端订阅并获取数据。</p><p>client中的receiver将负责通过Get命令接收数据，每获取到一个数据batch，都会由consumer根据对应表分发到不同的channel，每个channel都会为此数据batch产生一个发送数据的子任务Task。</p><p>在FE上，一个Task是channel向BE发送数据的子任务，里面包含分发到当前channel的同一个batch的数据。</p><p>channel控制着单个表事务的开始、提交、终止。一个事务周期内，一般会从consumer获取到多个batch的数据，因此会产生多个向BE发送数据的子任务Task，在提交事务成功前，这些Task不会实际生效。</p><p>满足一定条件时（比如超过一定时间、达到提交最大数据大小），consumer将会阻塞并通知各个channel提交事务。</p><p>当且仅当所有channel都提交成功，才会通过Ack命令通知canal并继续获取并消费数据。</p><p>如果有任意channel提交失败，将会重新从上一次消费成功的位置获取数据并再次提交（已提交成功的channel不会再次提交以保证幂等性）。</p><p>整个数据同步作业中，FE通过以上流程不断的从canal获取数据并提交到BE，来完成数据同步。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置mysql端">配置Mysql端<a href="#配置mysql端" class="hash-link" aria-label="配置Mysql端的直接链接" title="配置Mysql端的直接链接">​</a></h2><p>在Mysql Cluster模式的主从同步中，二进制日志文件(Binlog)记录了主节点上的所有数据变化，数据在Cluster的多个节点间同步、备份都要通过Binlog日志进行，从而提高集群的可用性。架构通常由一个主节点(负责写)和一个或多个从节点(负责读)构成，所有在主节点上发生的数据变更将会复制给从节点。</p><p><strong>注意：目前必须要使用Mysql 5.7及以上的版本才能支持Binlog Load功能。</strong></p><p>要打开mysql的二进制binlog日志功能，则需要编辑my.cnf配置文件设置一下。</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">[mysqld]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">log-bin = mysql-bin # 开启 binlog</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">binlog-format=ROW # 选择 ROW 模式</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mysql端说明">Mysql端说明<a href="#mysql端说明" class="hash-link" aria-label="Mysql端说明的直接链接" title="Mysql端说明的直接链接">​</a></h3><p>在Mysql上，Binlog命名格式为mysql-bin.000001、mysql-bin.000002... ，满足一定条件时mysql会去自动切分Binlog日志：</p><ol><li>mysql重启了</li><li>客户端输入命令flush logs</li><li>binlog文件大小超过1G</li></ol><p>要定位Binlog的最新的消费位置，可以通过binlog文件名和position(偏移量)。</p><p>例如，各个从节点上会保存当前消费到的binlog位置，方便随时断开连接、重新连接和继续消费。</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">---------------------                                ------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|       Slave       |              read              |      Master       |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| FileName/Position | &lt;&lt;&lt;--------------------------- |    Binlog Files   |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">---------------------                                ------------------</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>对于主节点来说，它只负责写入Binlog，多个从节点可以同时连接到一台主节点上，消费Binlog日志的不同部分，互相之间不会影响。</p><p>Binlog日志支持两种主要格式(此外还有混合模式mixed-based):</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">statement-based格式: Binlog只保存主节点上执行的sql语句，从节点将其复制到本地重新执行</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">row-based格式:       Binlog会记录主节点的每一行所有列的数据的变更信息，从节点会复制并执行每一行的变更到本地</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>第一种格式只写入了执行的sql语句，虽然日志量会很少，但是有下列缺点</p><ol><li>没有保存每一行实际的数据</li><li>在主节点上执行的UDF、随机、时间函数会在从节点上结果不一致</li><li>limit语句执行顺序可能不一致</li></ol><p>因此我们需要选择第二种格式，才能从Binlog日志中解析出每一行数据。</p><p>在row-based格式下，Binlog会记录每一条binlog event的时间戳，server id，偏移量等信息，如下面一条带有两条insert语句的事务:</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">begin;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">insert into canal_test.test_tbl values (3, 300);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">insert into canal_test.test_tbl values (4, 400);</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">commit;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>对应将会有四条binlog event，其中一条begin event，两条insert event，一条commit event：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">SET TIMESTAMP=1538238301/*!*/; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">/*!*/.</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># at 211935643</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># at 211935698</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#180930 0:25:01 server id 1 end_log_pos 211935698 Table_map: &#x27;canal_test&#x27;.&#x27;test_tbl&#x27; mapped to number 25 </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#180930 0:25:01 server id 1 end_log_pos 211935744 Write_rows: table-id 25 flags: STMT_END_F</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&#x27;/*!*/;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">### INSERT INTO canal_test.test_tbl</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">### SET</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">### @1=1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">### @2=100</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># at 211935744</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#180930 0:25:01 server id 1 end_log_pos 211935771 Xid = 2681726641</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&#x27;/*!*/;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">### INSERT INTO canal_test.test_tbl</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">### SET</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">### @1=2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">### @2=200</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># at 211935771</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#180930 0:25:01 server id 1 end_log_pos 211939510 Xid = 2681726641 </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">COMMIT/*!*/;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如上图所示，每条Insert event中包含了修改的数据。在进行Delete/Update操作时，一条event还能包含多行数据，使得Binlog日志更加的紧密。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="开启gtid模式-可选">开启GTID模式 <!-- -->[可选]<a href="#开启gtid模式-可选" class="hash-link" aria-label="开启gtid模式-可选的直接链接" title="开启gtid模式-可选的直接链接">​</a></h3><p>一个全局事务Id(global transaction identifier)标识出了一个曾在主节点上提交过的事务，在全局都是唯一有效的。开启了Binlog后，GTID会被写入到Binlog文件中，与事务一一对应。</p><p>要打开mysql的GTID模式，则需要编辑my.cnf配置文件设置一下</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">gtid-mode=on // 开启gtid模式</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">enforce-gtid-consistency=1 // 强制gtid和事务的一致性</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在GTID模式下，主服务器可以不需要Binlog的文件名和偏移量，就能很方便的追踪事务、恢复数据、复制副本。</p><p>在GTID模式下，由于GTID的全局有效性，从节点将不再需要通过保存文件名和偏移量来定位主节点上的Binlog位置，而通过数据本身就可以定位了。在进行数据同步中，从节点会跳过执行任意被识别为已执行的GTID事务。</p><p>GTID的表现形式为一对坐标, <code>source_id</code>标识出主节点，<code>transaction_id</code>表示此事务在主节点上执行的顺序(最大263-1)。</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">GTID = source_id:transaction_id</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>例如，在同一主节点上执行的第23个事务的gtid为</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">3E11FA47-71CA-11E1-9E33-C80AA9429562:23</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置canal端">配置Canal端<a href="#配置canal端" class="hash-link" aria-label="配置Canal端的直接链接" title="配置Canal端的直接链接">​</a></h2><p>canal是属于阿里巴巴otter项目下的一个子项目，主要用途是基于 MySQL 数据库增量日志解析，提供增量数据订阅和消费，用于解决跨机房同步的业务场景，建议使用canal 1.1.5及以上版本，<a href="https://github.com/alibaba/canal/releases" target="_blank" rel="noopener noreferrer">下载地址</a>，下载完成后，请按以下步骤完成部署。</p><ol><li><p>解压canal deployer</p></li><li><p>在conf文件夹下新建目录并重命名，作为instance的根目录，目录名即后文提到的destination</p></li><li><p>修改instance配置文件（可拷贝conf/example/instance.properties）</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">vim conf/{your destination}/instance.properties</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">## canal instance serverId</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">canal.instance.mysql.slaveId = 1234</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">## mysql address</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">canal.instance.master.address = 127.0.0.1:3306 </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">## mysql username/password</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">canal.instance.dbUsername = canal</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">canal.instance.dbPassword = canal</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>启动</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sh bin/startup.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p>验证启动成功</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">cat logs/{your destination}/{your destination}.log</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">2013-02-05 22:50:45.636 [main] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [canal.properties]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2013-02-05 22:50:45.641 [main] INFO  c.a.o.c.i.spring.support.PropertyPlaceholderConfigurer - Loading properties file from class path resource [xxx/instance.properties]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2013-02-05 22:50:45.803 [main] INFO  c.a.otter.canal.instance.spring.CanalInstanceWithSpring - start CannalInstance for 1-xxx </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2013-02-05 22:50:45.810 [main] INFO  c.a.otter.canal.instance.spring.CanalInstanceWithSpring - start successful....</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="canal端说明">Canal端说明<a href="#canal端说明" class="hash-link" aria-label="Canal端说明的直接链接" title="Canal端说明的直接链接">​</a></h3><p>canal通过伪造自己的mysql dump协议，去伪装成一个从节点，获取主节点的Binlog日志并解析。</p><p>canal server上可启动多个instance，一个instance可看作一个从节点，每个instance由下面几个部分组成：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">-------------------------------------------------</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|  Server                                       |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|  -------------------------------------------- |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|  |  Instance 1                              | |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|  |  -----------   -----------  -----------  | |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|  |  |  Parser |   |  Sink   |  | Store   |  | |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|  |  -----------   -----------  -----------  | |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|  |  -----------------------------------     | |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|  |  |             MetaManager         |     | |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|  |  -----------------------------------     | |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">|  -------------------------------------------- |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">-------------------------------------------------</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>parser：数据源接入，模拟slave协议和master进行交互，协议解析</li><li>sink：parser和store链接器，进行数据过滤，加工，分发的工作</li><li>store：数据存储</li><li>meta manager：元数据管理模块</li></ul><p>每个instance都有自己在cluster内的唯一标识，即server Id。</p><p>在canal server内，instance用字符串表示，此唯一字符串被记为destination，canal client需要通过destination连接到对应的instance。</p><p><strong>注意：canal client和canal instance是一一对应的</strong>，Binlog Load已限制多个数据同步作业不能连接到同一个destination。</p><p>数据在instance内的流向是binlog -&gt; parser -&gt; sink -&gt; store。</p><p>instance通过parser模块解析binlog日志，解析出来的数据缓存在store里面，当用户向FE提交一个数据同步作业时，会启动一个canal client订阅并获取对应instance中的store内的数据。</p><p>store实际上是一个环形的队列，用户可以自行配置它的长度和存储空间。</p><p><img loading="lazy" src="https://doris.apache.org/images/canal_store.png" alt="store" class="img_ev3q"></p><p>store通过三个指针去管理队列内的数据：</p><ol><li>get指针：get指针代表客户端最后获取到的位置。</li><li>ack指针：ack指针记录着最后消费成功的位置。</li><li>put指针：代表sink模块最后写入store成功的位置。</li></ol><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">canal client异步获取store中数据</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       get 0        get 1       get 2                    put</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         |            |           |         ......        |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         v            v           v                       v</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">--------------------------------------------------------------------- store环形队列</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         ^            ^</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         |            |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       ack 0        ack 1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>canal client调用get命令时，canal server会产生数据batch发送给client，并右移get指针，client可以获取多个batch，直到get指针赶上put指针为止。</p><p>当消费数据成功时，client会返回ack + batch Id通知已消费成功了，并右移ack指针，store会从队列中删除此batch的数据，腾出空间来从上游sink模块获取数据，并右移put指针。</p><p>当数据消费失败时，client会返回rollback通知消费失败，store会将get指针重置左移到ack指针位置，使下一次client获取的数据能再次从ack指针处开始。</p><p>和Mysql中的从节点一样，canal也需要去保存client最新消费到的位置。canal中所有元数据(如GTID、Binlog位置)都是由MetaManager去管理的，目前元数据默认以json格式持久化在instance根目录下的meta.dat文件内</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="基本操作">基本操作<a href="#基本操作" class="hash-link" aria-label="基本操作的直接链接" title="基本操作的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="配置目标表属性">配置目标表属性<a href="#配置目标表属性" class="hash-link" aria-label="配置目标表属性的直接链接" title="配置目标表属性的直接链接">​</a></h3><p>用户需要先在Doris端创建好与Mysql端对应的目标表</p><p>Binlog Load只能支持Unique类型的目标表，且必须激活目标表的Batch Delete功能。</p><p>开启Batch Delete的方法可以参考<a href="/zh-CN/docs/sql-manual/sql-reference/Data-Definition-Statements/Alter/ALTER-TABLE-PROPERTY">ALTER TABLE PROPERTY</a>中的批量删除功能。</p><p>示例：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">--create Mysql table</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE TABLE `demo.source_test` (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  `id` int(11) NOT NULL COMMENT &quot;&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  `name` int(11) NOT NULL COMMENT &quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">-- create Doris table</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE TABLE `target_test` (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  `id` int(11) NOT NULL COMMENT &quot;&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  `name` int(11) NOT NULL COMMENT &quot;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">) ENGINE=OLAP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">UNIQUE KEY(`id`)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">COMMENT &quot;OLAP&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">DISTRIBUTED BY HASH(`id`) BUCKETS 8;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">-- enable batch delete</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ALTER TABLE target_test ENABLE FEATURE &quot;BATCH_DELETE&quot;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>！！Doris表结构和Mysql表结构字段顺序必须保持一致！！</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="创建同步作业">创建同步作业<a href="#创建同步作业" class="hash-link" aria-label="创建同步作业的直接链接" title="创建同步作业的直接链接">​</a></h3><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE SYNC `demo`.`job`</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">FROM `demo`.`source_test1` INTO `target_test`</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">(id,name)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">FROM BINLOG</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;type&quot; = &quot;canal&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;canal.server.ip&quot; = &quot;127.0.0.1&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;canal.server.port&quot; = &quot;11111&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;canal.destination&quot; = &quot;xxx&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;canal.username&quot; = &quot;canal&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;canal.password&quot; = &quot;canal&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>创建数据同步作业的详细语法可以连接到 Doris 后，<a href="/zh-CN/docs/sql-manual/sql-reference/Data-Manipulation-Statements/Load/CREATE-SYNC-JOB">CREATE SYNC JOB</a> 查看语法帮助。这里主要详细介绍，创建作业时的注意事项。</p><p>语法：</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE SYNC [db.]job_name</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        channel_desc, </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        channel_desc</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        ...</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">binlog_desc</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><p>job_name</p><p><code>job_name</code>是数据同步作业在当前数据库内的唯一标识，相同<code>job_name</code>的作业只能有一个在运行。</p></li><li><p>channel_desc</p><p><code>channel_desc</code>用来定义任务下的数据通道，可表示mysql源表到doris目标表的映射关系。在设置此项时，如果存在多个映射关系，必须满足mysql源表应该与doris目标表是一一对应关系，其他的任何映射关系（如一对多关系），检查语法时都被视为不合法。</p></li><li><p>column_mapping</p><p><code>column_mapping</code>主要指mysql源表和doris目标表的列之间的映射关系，如果不指定，FE会默认源表和目标表的列按顺序一一对应。但是我们依然建议显式的指定列的映射关系，这样当目标表的结构发生变化（比如增加一个 nullable 的列），数据同步作业依然可以进行。否则，当发生上述变动后，因为列映射关系不再一一对应，导入将报错。</p></li><li><p>binlog_desc</p><p><code>binlog_desc</code>中的属性定义了对接远端Binlog地址的一些必要信息，目前可支持的对接类型只有canal方式，所有的配置项前都需要加上canal前缀。</p><ol><li><code>canal.server.ip</code>: canal server的地址</li><li><code>canal.server.port</code>: canal server的端口</li><li><code>canal.destination</code>: 前文提到的instance的字符串标识</li><li><code>canal.batchSize</code>: 每批从canal server处获取的batch大小的最大值，默认8192</li><li><code>canal.username</code>: instance的用户名</li><li><code>canal.password</code>: instance的密码</li><li><code>canal.debug</code>: 设置为true时，会将batch和每一行数据的详细信息都打印出来，会影响性能。</li></ol></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="查看作业状态">查看作业状态<a href="#查看作业状态" class="hash-link" aria-label="查看作业状态的直接链接" title="查看作业状态的直接链接">​</a></h3><p>查看作业状态的具体命令和示例可以通过 <a href="/zh-CN/docs/sql-manual/sql-reference/Show-Statements/SHOW-SYNC-JOB">SHOW SYNC JOB</a> 命令查看。</p><p>返回结果集的参数意义如下：</p><ul><li><p>State</p><p>作业当前所处的阶段。作业状态之间的转换如下图所示：</p><div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">                   +-------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       create job  |  PENDING    |    resume job</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       +-----------+             &lt;-------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       |           +-------------+             |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  +----v-------+                       +-------+----+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  |  RUNNING   |     pause job         |  PAUSED    |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  |            +-----------------------&gt;            |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  +----+-------+     run error         +-------+----+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       |           +-------------+             |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       |           | CANCELLED   |             |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">       +-----------&gt;             &lt;-------------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      stop job     +-------------+    stop job</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">      system error</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>作业提交之后状态为PENDING，由FE调度执行启动canal client后状态变成RUNNING，用户可以通过 STOP/PAUSE/RESUME 三个命令来控制作业的停止，暂停和恢复，操作后作业状态分别为CANCELLED/PAUSED/RUNNING。</p><p>作业的最终阶段只有一个CANCELLED，当作业状态变为CANCELLED后，将无法再次恢复。当作业发生了错误时，若错误是不可恢复的，状态会变成CANCELLED，否则会变成PAUSED。</p></li><li><p>Channel</p><p>作业所有源表到目标表的映射关系。</p></li><li><p>Status</p><p>当前binlog的消费位置(若设置了GTID模式，会显示GTID)，以及doris端执行时间相比mysql端的延迟时间。</p></li><li><p>JobConfig</p><p>对接的远端服务器信息，如canal server的地址与连接instance的destination</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="控制作业">控制作业<a href="#控制作业" class="hash-link" aria-label="控制作业的直接链接" title="控制作业的直接链接">​</a></h3><p>用户可以通过 STOP/PAUSE/RESUME 三个命令来控制作业的停止，暂停和恢复。可以通过 <a href="/zh-CN/docs/sql-manual/sql-reference/Data-Manipulation-Statements/Load/STOP-SYNC-JOB">STOP SYNC JOB</a> ; <a href="/zh-CN/docs/sql-manual/sql-reference/Data-Manipulation-Statements/Load/PAUSE-SYNC-JOB">PAUSE SYNC JOB</a>; 以及 <a href="/zh-CN/docs/sql-manual/sql-reference/Data-Manipulation-Statements/Load/RESUME-SYNC-JOB">RESUME SYNC JOB</a>; </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="相关参数">相关参数<a href="#相关参数" class="hash-link" aria-label="相关参数的直接链接" title="相关参数的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="canal配置">CANAL配置<a href="#canal配置" class="hash-link" aria-label="CANAL配置的直接链接" title="CANAL配置的直接链接">​</a></h3><p>下面配置属于canal端的配置，主要通过修改 conf 目录下的 canal.properties 调整配置值。</p><ul><li><p><code>canal.ip</code></p><p>canal server的ip地址</p></li><li><p><code>canal.port</code></p><p>canal server的端口</p></li><li><p><code>canal.instance.memory.buffer.size</code></p><p>canal端的store环形队列的队列长度，必须设为2的幂次方，默认长度16384。此值等于canal端能缓存event数量的最大值，也直接决定了Doris端一个事务内所能容纳的最大event数量。建议将它改的足够大，防止Doris端一个事务内能容纳的数据量上限太小，导致提交事务太过频繁造成数据的版本堆积。</p></li><li><p><code>canal.instance.memory.buffer.memunit</code></p><p>canal端默认一个event所占的空间，默认空间为1024 bytes。此值乘上store环形队列的队列长度等于store的空间最大值，比如store队列长度为16384，则store的空间为16MB。但是，一个event的实际大小并不等于此值，而是由这个event内有多少行数据和每行数据的长度决定的，比如一张只有两列的表的insert event只有30字节，但delete event可能达到数千字节，这是因为通常delete event的行数比insert event多。</p></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fe配置">FE配置<a href="#fe配置" class="hash-link" aria-label="FE配置的直接链接" title="FE配置的直接链接">​</a></h3><p>下面配置属于数据同步作业的系统级别配置，主要通过修改 fe.conf 来调整配置值。</p><ul><li><p><code>sync_commit_interval_second</code></p><p>提交事务的最大时间间隔。若超过了这个时间channel中还有数据没有提交，consumer会通知channel提交事务。</p></li><li><p><code>min_sync_commit_size</code></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">提交事务需满足的最小event数量。若Fe接收到的event数量小于它，会继续等待下一批数据直到时间超过了`sync_commit_interval_second `为止。默认值是10000个events，如果你想修改此配置，请确保此值小于canal端的`canal.instance.memory.buffer.size`配置（默认16384），否则在ack前Fe会尝试获取比store队列长度更多的event，导致store队列阻塞至超时为止。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><code>min_bytes_sync_commit</code></p><p>提交事务需满足的最小数据大小。若Fe接收到的数据大小小于它，会继续等待下一批数据直到时间超过了<code>sync_commit_interval_second</code>为止。默认值是15MB，如果你想修改此配置，请确保此值小于canal端的<code>canal.instance.memory.buffer.size</code>和<code>canal.instance.memory.buffer.memunit</code>的乘积（默认16MB），否则在ack前Fe会尝试获取比store空间更大的数据，导致store队列阻塞至超时为止。</p></li><li><p><code>max_bytes_sync_commit</code></p><p>提交事务时的数据大小的最大值。若Fe接收到的数据大小大于它，会立即提交事务并发送已积累的数据。默认值是64MB，如果你想修改此配置，请确保此值大于canal端的<code>canal.instance.memory.buffer.size</code>和<code>canal.instance.memory.buffer.memunit</code>的乘积（默认16MB）和<code>min_bytes_sync_commit</code>。</p></li><li><p><code>max_sync_task_threads_num</code></p><p>数据同步作业线程池中的最大线程数量。此线程池整个FE中只有一个，用于处理FE中所有数据同步作业向BE发送数据的任务task，线程池的实现在<code>SyncTaskPool</code>类。</p></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="常见问题">常见问题<a href="#常见问题" class="hash-link" aria-label="常见问题的直接链接" title="常见问题的直接链接">​</a></h2><ol><li><p>修改表结构是否会影响数据同步作业？</p><p>会影响。数据同步作业并不能禁止<code>alter table</code>的操作，当表结构发生了变化，如果列的映射无法匹配，可能导致作业发生错误暂停，建议通过在数据同步作业中显式指定列映射关系，或者通过增加 Nullable 列或带 Default 值的列来减少这类问题。</p></li><li><p>删除了数据库后数据同步作业还会继续运行吗？</p><p>不会。删除数据库后的几秒日志中可能会出现找不到元数据的错误，之后该数据同步作业会被FE的定时调度检查时停止。</p></li><li><p>多个数据同步作业可以配置相同的<code>ip:port + destination</code>吗？</p><p>不能。创建数据同步作业时会检查<code>ip:port + destination</code>与已存在的作业是否重复，防止出现多个作业连接到同一个instance的情况。</p></li><li><p>为什么数据同步时浮点类型的数据精度在Mysql端和Doris端不一样？</p><p>Doris本身浮点类型的精度与Mysql不一样。可以选择用Decimal类型代替</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="更多帮助">更多帮助<a href="#更多帮助" class="hash-link" aria-label="更多帮助的直接链接" title="更多帮助的直接链接">​</a></h2><p>关于 Binlog Load 使用的更多详细语法及最佳实践，请参阅 <a href="/zh-CN/docs/sql-manual/sql-reference/Data-Manipulation-Statements/Load/CREATE-SYNC-JOB">Binlog Load</a> 命令手册，你也可以在 MySql 客户端命令行下输入 <code>HELP BINLOG</code> 获取更多帮助信息。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#适用场景" class="table-of-contents__link toc-highlight">适用场景</a></li><li><a href="#基本原理" class="table-of-contents__link toc-highlight">基本原理</a></li><li><a href="#配置mysql端" class="table-of-contents__link toc-highlight">配置Mysql端</a><ul><li><a href="#mysql端说明" class="table-of-contents__link toc-highlight">Mysql端说明</a></li><li><a href="#开启gtid模式-可选" class="table-of-contents__link toc-highlight">开启GTID模式 可选</a></li></ul></li><li><a href="#配置canal端" class="table-of-contents__link toc-highlight">配置Canal端</a><ul><li><a href="#canal端说明" class="table-of-contents__link toc-highlight">Canal端说明</a></li></ul></li><li><a href="#基本操作" class="table-of-contents__link toc-highlight">基本操作</a><ul><li><a href="#配置目标表属性" class="table-of-contents__link toc-highlight">配置目标表属性</a></li><li><a href="#创建同步作业" class="table-of-contents__link toc-highlight">创建同步作业</a></li><li><a href="#查看作业状态" class="table-of-contents__link toc-highlight">查看作业状态</a></li><li><a href="#控制作业" class="table-of-contents__link toc-highlight">控制作业</a></li></ul></li><li><a href="#相关参数" class="table-of-contents__link toc-highlight">相关参数</a><ul><li><a href="#canal配置" class="table-of-contents__link toc-highlight">CANAL配置</a></li><li><a href="#fe配置" class="table-of-contents__link toc-highlight">FE配置</a></li></ul></li><li><a href="#常见问题" class="table-of-contents__link toc-highlight">常见问题</a></li><li><a href="#更多帮助" class="table-of-contents__link toc-highlight">更多帮助</a></li></ul></div></div></div></div></main></div></div></div><div class="footer"><div class="container"><div class="footer-box"><div class="left"><img src="/zh-CN/images/asf_logo_apache.svg" alt="" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/zh-CN/images/asf_logo_apache.svg" alt="" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ASF</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Foundation<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="footer__link-item">License<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="footer__link-item">Events<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sponsorship<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Thanks<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-CN/download">Download</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-CN/learning">Docs</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-CN/blog">Blogs</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-CN/users">User Stories</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community Support</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/zh-CN/community/team">Doris Team</a></li><li class="footer__item"><a class="footer__link-item" href="/zh-CN/community/how-to-contribute/">How to Contribute</a></li><li class="footer__item"><a href="https://github.com/apache/doris/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Source Code<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/doris/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">Improvement Proposal<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/apache/doris/issues/16392" target="_blank" rel="noopener noreferrer" class="footer__link-item">Roadmap<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div><div class="right"><div class="footer__title">Connect with Us</div><div class="social-list"><div class="social"><a href="mailto:dev@doris.apache.org" target="_blank" title="mail" class="item"><svg width="2em" height="2em" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5.6003 6H26.3997C27.8186 6 28.982 7.10964 29 8.46946L16.0045 15.454L3.01202 8.47829C3.02405 7.11258 4.1784 6 5.6003 6ZM3.01202 11.1508L3 23.5011C3 24.8756 4.16938 26 5.6003 26H26.3997C27.8306 26 29 24.8756 29 23.5011V11.145L16.3111 17.8028C16.1157 17.9058 15.8813 17.9058 15.6889 17.8028L3.01202 11.1508V11.1508Z" fill="currentColor"></path></svg></a><a href="https://github.com/apache/doris" target="_blank" title="github" class="item"><svg width="2em" height="2em" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M16.0001 2.66675C8.63342 2.66675 2.66675 8.63341 2.66675 16.0001C2.66524 18.7991 3.54517 21.5276 5.1817 23.7983C6.81824 26.0691 9.12828 27.7668 11.7841 28.6508C12.4508 28.7668 12.7001 28.3668 12.7001 28.0161C12.7001 27.7001 12.6828 26.6508 12.6828 25.5334C9.33342 26.1508 8.46675 24.7174 8.20008 23.9668C8.04942 23.5828 7.40008 22.4001 6.83342 22.0828C6.36675 21.8334 5.70008 21.2161 6.81608 21.2001C7.86675 21.1828 8.61608 22.1668 8.86675 22.5668C10.0668 24.5828 11.9841 24.0161 12.7494 23.6668C12.8668 22.8001 13.2161 22.2174 13.6001 21.8841C10.6334 21.5508 7.53342 20.4001 7.53342 15.3001C7.53342 13.8494 8.04942 12.6507 8.90008 11.7161C8.76675 11.3827 8.30008 10.0161 9.03342 8.18275C9.03342 8.18275 10.1494 7.83342 12.7001 9.55075C13.7855 9.2495 14.907 9.09787 16.0334 9.10008C17.1668 9.10008 18.3001 9.24942 19.3668 9.54942C21.9161 7.81608 23.0334 8.18408 23.0334 8.18408C23.7668 10.0174 23.3001 11.3841 23.1668 11.7174C24.0161 12.6507 24.5334 13.8334 24.5334 15.3001C24.5334 20.4174 21.4174 21.5508 18.4508 21.8841C18.9334 22.3001 19.3508 23.1001 19.3508 24.3508C19.3508 26.1334 19.3334 27.5668 19.3334 28.0174C19.3334 28.3668 19.5841 28.7828 20.2508 28.6494C22.8975 27.7558 25.1973 26.0547 26.8266 23.7856C28.4559 21.5165 29.3327 18.7936 29.3334 16.0001C29.3334 8.63341 23.3668 2.66675 16.0001 2.66675V2.66675Z" fill="currentColor"></path></svg></a><a href="https://twitter.com/doris_apache" target="_blank" title="twitter" class="item"><svg width="2rem" height="2rem" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 3H10.6067L29 29H21.3933L3 3ZM6.31485 4.69302L22.3127 27.307H25.6852L9.68727 4.69302H6.31485Z" fill="white"></path><path d="M14.202 18.8346L5.18225 29H3L13.2092 17.4314L14.202 18.8346ZM18.4342 14.0647L28.2518 3H25.9448L17.4314 12.6471L18.4342 14.0647Z" fill="white"></path></svg></a></div><div class="social"><a href="https://join.slack.com/t/apachedoriscommunity/shared_invite/zt-28il1o2wk-DD6LsLOz3v4aD92Mu0S0aQ" title="slack" target="_blank" class="item"><svg width="2em" height="2em" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_125_278)"><path d="M12.5875 16.6906C11.0844 16.6906 9.86562 17.9094 9.86562 19.4125V26.2375C9.86562 26.9594 10.1524 27.6517 10.6628 28.1622C11.1733 28.6726 11.8656 28.9594 12.5875 28.9594C13.3094 28.9594 14.0017 28.6726 14.5122 28.1622C15.0226 27.6517 15.3094 26.9594 15.3094 26.2375V19.4531C15.3094 17.9094 14.0906 16.6906 12.5875 16.6906ZM3 19.4531C3 20.175 3.28677 20.8673 3.79722 21.3778C4.30767 21.8882 4.99999 22.175 5.72187 22.175C6.44376 22.175 7.13608 21.8882 7.64653 21.3778C8.15698 20.8673 8.44375 20.175 8.44375 19.4531V16.7312H5.7625C4.25938 16.6906 3 17.9094 3 19.4531ZM12.5875 3C11.8656 3 11.1733 3.28677 10.6628 3.79722C10.1524 4.30767 9.86562 4.99999 9.86562 5.72187C9.86562 6.44376 10.1524 7.13608 10.6628 7.64653C11.1733 8.15698 11.8656 8.44375 12.5875 8.44375H15.3094V5.72187C15.3094 4.21875 14.0906 3 12.5875 3ZM5.72187 15.3094H12.5469C13.2688 15.3094 13.9611 15.0226 14.4715 14.5122C14.982 14.0017 15.2688 13.3094 15.2688 12.5875C15.2688 11.8656 14.982 11.1733 14.4715 10.6628C13.9611 10.1524 13.2688 9.86562 12.5469 9.86562H5.72187C4.99999 9.86562 4.30767 10.1524 3.79722 10.6628C3.28677 11.1733 3 11.8656 3 12.5875C3 13.3094 3.28677 14.0017 3.79722 14.5122C4.30767 15.0226 4.99999 15.3094 5.72187 15.3094ZM26.2375 9.86562C24.7344 9.86562 23.5156 11.0844 23.5156 12.5875V15.3094H26.2375C26.9594 15.3094 27.6517 15.0226 28.1622 14.5122C28.6726 14.0017 28.9594 13.3094 28.9594 12.5875C28.9594 11.8656 28.6726 11.1733 28.1622 10.6628C27.6517 10.1524 26.9594 9.86562 26.2375 9.86562ZM16.6906 5.72187V12.5875C16.6906 13.3094 16.9774 14.0017 17.4878 14.5122C17.9983 15.0226 18.6906 15.3094 19.4125 15.3094C20.1344 15.3094 20.8267 15.0226 21.3372 14.5122C21.8476 14.0017 22.1344 13.3094 22.1344 12.5875V5.72187C22.1344 4.99999 21.8476 4.30767 21.3372 3.79722C20.8267 3.28677 20.1344 3 19.4125 3C18.6906 3 17.9983 3.28677 17.4878 3.79722C16.9774 4.30767 16.6906 4.99999 16.6906 5.72187ZM22.1344 26.2781C22.1344 24.775 20.9156 23.5562 19.4125 23.5562H16.6906V26.2781C16.6906 27 16.9774 27.6923 17.4878 28.2028C17.9983 28.7132 18.6906 29 19.4125 29C20.1344 29 20.8267 28.7132 21.3372 28.2028C21.8476 27.6923 22.1344 27 22.1344 26.2781ZM26.2781 16.6906H19.4125C18.6906 16.6906 17.9983 16.9774 17.4878 17.4878C16.9774 17.9983 16.6906 18.6906 16.6906 19.4125C16.6906 20.1344 16.9774 20.8267 17.4878 21.3372C17.9983 21.8476 18.6906 22.1344 19.4125 22.1344H26.2375C27.7406 22.1344 28.9594 20.9156 28.9594 19.4125C29 17.9094 27.7812 16.6906 26.2781 16.6906Z" fill="currentColor"></path></g><defs><clipPath id="clip0_125_278"><rect width="26" height="26" fill="currentColor" transform="translate(3 3)"></rect></clipPath></defs></svg></a><a href="https://www.youtube.com/@apachedoris/channels" title="youtube" target="_blank" class="item"><svg width="2rem" height="2rem" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_3462_1106)"><path d="M30.3048 7.66776C30.7927 8.14769 31.1465 8.74331 31.3319 9.39705C31.7949 11.91 32.0182 14.46 31.9988 17.0138C32.0164 19.558 31.7931 22.0982 31.3319 24.6017C31.1465 25.2554 30.7927 25.851 30.3048 26.3309C29.8169 26.8109 29.2115 27.1589 28.5469 27.3413C26.026 28 16.0142 28 16.0142 28C16.0142 28 5.97317 28 3.48158 27.3413C2.81702 27.1589 2.21154 26.8109 1.72366 26.3309C1.23579 25.851 0.882017 25.2554 0.696547 24.6017C0.22555 22.0991 -0.00754264 19.5589 0.000288097 17.0138C-0.00936809 14.4591 0.223732 11.9091 0.696547 9.39705C0.882017 8.74331 1.23579 8.14769 1.72366 7.66776C2.21154 7.18784 2.81702 6.83983 3.48158 6.65738C6.00118 5.9869 16.0142 6.00002 16.0142 6.00002C16.0142 6.00002 26.0526 6.00002 28.5469 6.65738C29.2115 6.83983 29.8169 7.18784 30.3048 7.66776ZM12 23L22 17.0092L12 11V23Z" fill="white"></path></g><defs><clipPath id="clip0_3462_1106"><rect width="32" height="32" fill="white"></rect></clipPath></defs></svg></a><a href="https://www.linkedin.com/company/doris-apache/" title="linkedin" target="_blank" class="item"><svg width="2rem" height="2rem" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4.29925 26.9996H9.66738V11.6781H4.29925V26.9996ZM22.1628 11.1949C19.9409 11.1949 18.7157 11.9388 17.3054 13.7407V11.6777H11.9459V26.9996H17.305V18.6738C17.305 16.9168 18.145 15.1982 20.1535 15.1982C22.162 15.1982 22.6559 16.9164 22.6559 18.632V27H28V18.2902C28 12.2386 24.3854 11.1949 22.1628 11.1949ZM6.99325 4C5.3395 4 4 5.21047 4 6.7046C4 8.19759 5.3395 9.40617 6.99325 9.40617C8.6455 9.40617 9.985 8.19722 9.985 6.7046C9.985 5.21047 8.6455 4 6.99325 4Z" fill="white"></path></svg></a></div></div></div></div><div class="footer__copyright">Copyright © 2023 The Apache Software Foundation,Licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache License, Version 2.0</a>. Apache, Doris, Apache Doris, the Apache feather logo and the Apache Doris logo are trademarks of The Apache Software Foundation.</div></div></div></div>
<script src="https://cdnd.selectdb.com/zh-CN/assets/js/runtime~main.6055e683.js"></script>
<script src="https://cdnd.selectdb.com/zh-CN/assets/js/main.afdadd9e.js"></script>
</body>
</html>