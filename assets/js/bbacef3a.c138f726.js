"use strict";(self.webpackChunkdoris_website=self.webpackChunkdoris_website||[]).push([[38924],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>m});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),c=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},p=function(e){var t=c(e.components);return n.createElement(s.Provider,{value:t},e.children)},d="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=c(a),h=r,m=d["".concat(s,".").concat(h)]||d[h]||u[h]||i;return a?n.createElement(m,o(o({ref:t},p),{},{components:a})):n.createElement(m,o({ref:t},p))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,o=new Array(i);o[0]=h;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[d]="string"==typeof e?e:r,o[1]=l;for(var c=2;c<i;c++)o[c]=a[c];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},45033:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>u,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var n=a(87462),r=(a(67294),a(3905));const i={title:"Partition Cache",language:"en"},o=void 0,l={unversionedId:"advanced/cache/partition-cache-manual",id:"advanced/cache/partition-cache-manual",title:"Partition Cache",description:"\x3c!--",source:"@site/docs/advanced/cache/partition-cache-manual.md",sourceDirName:"advanced/cache",slug:"/advanced/cache/partition-cache-manual",permalink:"/docs/dev/advanced/cache/partition-cache-manual",draft:!1,tags:[],version:"current",frontMatter:{title:"Partition Cache",language:"en"},sidebar:"docs",previous:{title:"Auto Partition",permalink:"/docs/dev/advanced/partition/auto-partition"},next:{title:"Query Cache",permalink:"/docs/dev/advanced/cache/query-cache"}},s={},c=[{value:"Demand scenarios &amp; solutions",id:"demand-scenarios--solutions",level:2},{value:"Design principles",id:"design-principles",level:2},{value:"Usage",id:"usage",level:2},{value:"Related parameters",id:"related-parameters",level:2},{value:"Implementation principle example",id:"implementation-principle-example",level:2}],p={toc:c},d="wrapper";function u(e){let{components:t,...a}=e;return(0,r.kt)(d,(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"partition-cache"},"Partition Cache"),(0,r.kt)("p",null,"Cache hits can occur when multiple SQLs use the same table partition."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"**Partition Cache is an experimental feature and is not well maintained. Use it with caution**\n")),(0,r.kt)("h2",{id:"demand-scenarios--solutions"},"Demand scenarios & solutions"),(0,r.kt)("p",null,"See query-cache.md."),(0,r.kt)("h2",{id:"design-principles"},"Design principles"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"SQL can be split in parallel, Q = Q1 \u222a Q2 ... \u222a Qn, R= R1 \u222a R2 ... \u222a Rn, Q is the query statement, R is the result set")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Split into read-only partitions and updateable partitions, read-only partitions are cached, update partitions are not cached"))),(0,r.kt)("p",null,"As above, query the number of daily users in the last 7 days. For example, if partitioned by date, the data will only be written to the partition of the current day. The data of other partitions other than the current day are fixed. Under the same query SQL, query a certain area that is not updated. The partition indicators are all fixed. As follows, the number of users in the previous 7 days is queried on 2020-03-09. The data from 2020-03-03 to 2020-03-07 comes from the cache. The first query on 2020-03-08 comes from the partition, and subsequent queries come from the cache. , 2020-03-09 because it was written continuously that day, so it comes from the partition."),(0,r.kt)("p",null,"Therefore, to query N days of data, the data is updated for the most recent D days. Similar queries with different date ranges every day only need to query D partitions. The other parts come from the cache, which can effectively reduce the cluster load and query time."),(0,r.kt)("p",null,"In addition some restrictions:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Only supports grouping by partition fields, not by other fields. Grouping by other fields may cause the group data to be updated, which will cause the cache to become invalid.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Only the first half, second half and all hits of the result set are supported. The result set is not supported to be divided into several parts by cached data."))),(0,r.kt)("h2",{id:"usage"},"Usage"),(0,r.kt)("p",null,"Make sure cache_enable_partition_mode=true in fe.conf (default is true)"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"vim fe/conf/fe.conf\ncache_enable_partition_mode=true\n")),(0,r.kt)("p",null,"Set variables in MySQL command line"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"MySQL [(none)]> set [global] enable_partition_cache=true;\n")),(0,r.kt)("p",null,"If two caching strategies are enabled at the same time, you need to pay attention to the following parameters:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"cache_last_version_interval_second=900\n")),(0,r.kt)("p",null,"If the interval between the latest version of the partition and the present is greater than cache_last_version_interval_second, the entire query result will be cached first. If it is less than this interval, if it meets the conditions of PartitionCache, the PartitionCache data will be pressed."),(0,r.kt)("h2",{id:"related-parameters"},"Related parameters"),(0,r.kt)("p",null,"For detailed parameter introduction, see query-cache.md"),(0,r.kt)("h2",{id:"implementation-principle-example"},"Implementation principle example"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},'MySQL [(none)]> SELECT eventdate,count(userid) FROM testdb.appevent WHERE eventdate>="2020-03-03" AND eventdate<="2020-03-09" GROUP BY eventdate ORDER BY eventdate;\n+----------------+-----------------+\n| eventdate | count(`userid`) |\n+----------------+-----------------+\n| 2020-03-03 | 15 |\n| 2020-03-04 | 20 |\n| 2020-03-05 | 25 |\n| 2020-03-06 | 30 |\n| 2020-03-07 | 35 |\n| 2020-03-08 | 40 | //The first time comes from the partition, and the subsequent ones come from the cache\n| 2020-03-09 | 25 | //From partition\n+----------------+-----------------+\n7 rows in set (0.02 sec)\n')),(0,r.kt)("p",null,"In PartitionCache, the cached first-level Key is the 128-bit MD5 signature of the SQL after removing the partition conditions. The following is the rewritten SQL to be signed:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},"SELECT eventdate,count(userid) FROM testdb.appevent GROUP BY eventdate ORDER BY eventdate;\n")),(0,r.kt)("p",null,"The cached second-level key is the content of the partition field of the query result set, such as the content of the eventdate column of the query result above. The ancillary information of the second-level key is the version number and version update time of the partition."),(0,r.kt)("p",null,"The following demonstrates the process of executing the above SQL for the first time on 2020-03-09:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Get data from cache")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"+----------------+-----------------+\n| 2020-03-03 | 15 |\n| 2020-03-04 | 20 |\n| 2020-03-05 | 25 |\n| 2020-03-06 | 30 |\n| 2020-03-07 | 35 |\n+----------------+-----------------+\n")),(0,r.kt)("ol",{start:2},(0,r.kt)("li",{parentName:"ol"},"SQL and data to get data from BE")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-sql"},'SELECT eventdate,count(userid) FROM testdb.appevent WHERE eventdate>="2020-03-08" AND eventdate<="2020-03-09" GROUP BY eventdate ORDER BY eventdate;\n\n+----------------+-----------------+\n| 2020-03-08 | 40 |\n+----------------+-----------------+\n| 2020-03-09 | 25 |\n+----------------+-----------------+\n')),(0,r.kt)("ol",{start:3},(0,r.kt)("li",{parentName:"ol"},"The last data sent to the terminal")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"+----------------+-----------------+\n| eventdate | count(`userid`) |\n+----------------+-----------------+\n| 2020-03-03 | 15 |\n| 2020-03-04 | 20 |\n| 2020-03-05 | 25 |\n| 2020-03-06 | 30 |\n| 2020-03-07 | 35 |\n| 2020-03-08 | 40 |\n| 2020-03-09 | 25 |\n+----------------+-----------------+\n")),(0,r.kt)("ol",{start:4},(0,r.kt)("li",{parentName:"ol"},"Data sent to cache")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},"+----------------+-----------------+\n| 2020-03-08 | 40 |\n+----------------+-----------------+\n")),(0,r.kt)("p",null,"Partition cache is suitable for partitioning by date, some partitions are updated in real time, and the query SQL is relatively fixed."),(0,r.kt)("p",null,"The partition field can also be other fields, but it needs to be ensured that only a small number of partitions are updated."))}u.isMDXComponent=!0}}]);